openapi: 3.0.0
info:
  title: Battery Analysis Platform API
  description: |
    储能电池寿命分析及算法测试平台 API 规范

    核心功能:
    - 用户认证与授权 (JWT)
    - 数据管理与可视化分析
    - 训练平台 (Baseline/BiLSTM/DeepHPM)
    - 测试平台 (模型推理评估)
    - 模型版本管理
    - WebSocket实时进度推送
  version: 1.0.0

servers:
  - url: http://localhost:8000/api/v1
    description: 本地开发服务器

tags:
  - name: Authentication
    description: 用户认证与授权
  - name: Data Management
    description: 数据集和电池数据管理
  - name: Analysis
    description: 数据可视化分析
  - name: Training
    description: 训练平台
  - name: Models
    description: 模型版本管理
  - name: Testing
    description: 测试平台
  - name: WebSocket
    description: WebSocket实时推送

paths:
  # ==========================================
  # Authentication
  # ==========================================
  /auth/register:
    post:
      tags: [Authentication]
      summary: 用户注册
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_name, email, password]
              properties:
                user_name:
                  type: string
                email:
                  type: string
                  format: email
                password:
                  type: string
      responses:
        "201":
          description: 注册成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  user_name:
                    type: string
                  email:
                    type: string
        "409":
          description: 邮箱已被注册

  /auth/login:
    post:
      tags: [Authentication]
      summary: 用户登录
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required: [username, password]
              properties:
                username:
                  type: string
                  description: 用户邮箱
                password:
                  type: string
      responses:
        "200":
          description: 登录成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  token_type:
                    type: string
        "401":
          description: 用户名或密码错误

  /auth/me:
    get:
      tags: [Authentication]
      summary: 获取当前用户信息
      security:
        - BearerAuth: []
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  user_name:
                    type: string
                  email:
                    type: string

  /auth/logout:
    post:
      tags: [Authentication]
      summary: 用户登出
      security:
        - BearerAuth: []
      responses:
        "200":
          description: 登出成功

  # ==========================================
  # Data Management
  # ==========================================
  /data/datasets:
    get:
      tags: [Data Management]
      summary: 获取数据集列表
      description: MVP版本仅返回内置数据集
      security:
        - BearerAuth: []
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: integer
                    name:
                      type: string
                    source_type:
                      type: string
                    battery_count:
                      type: integer
                    created_at:
                      type: string
                      format: date-time

  /data/datasets/{dataset_id}/batteries:
    get:
      tags: [Data Management]
      summary: 获取数据集中的电池列表
      security:
        - BearerAuth: []
      parameters:
        - name: dataset_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: integer
                    battery_code:
                      type: string
                    group_tag:
                      type: string
                      nullable: true
                    total_cycles:
                      type: integer
                    nominal_capacity:
                      type: number
                      nullable: true

  /data/batteries/{battery_id}/cycles:
    get:
      tags: [Data Management]
      summary: 获取电池的循环数据
      security:
        - BearerAuth: []
      parameters:
        - name: battery_id
          in: path
          required: true
          schema:
            type: integer
        - name: skip
          in: query
          schema:
            type: integer
            default: 0
        - name: limit
          in: query
          schema:
            type: integer
            default: 100
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    cycle_num:
                      type: integer
                    feature_1:
                      type: number
                    feature_2:
                      type: number
                    feature_3:
                      type: number
                    feature_4:
                      type: number
                    feature_5:
                      type: number
                    feature_6:
                      type: number
                    feature_7:
                      type: number
                    feature_8:
                      type: number
                    pcl:
                      type: number
                      nullable: true
                    rul:
                      type: integer
                      nullable: true

  # ==========================================
  # Analysis
  # ==========================================
  /data/batteries/{battery_id}/stats:
    get:
      tags: [Analysis]
      summary: 获取特征统计 (8x6表格)
      security:
        - BearerAuth: []
      parameters:
        - name: battery_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    feature_name:
                      type: string
                    mean:
                      type: number
                    variance:
                      type: number
                    min_val:
                      type: number
                    max_val:
                      type: number
                    corr_rul:
                      type: number
                      nullable: true
                    corr_pcl:
                      type: number
                      nullable: true

  /data/batteries/{battery_id}/trend:
    get:
      tags: [Analysis]
      summary: 获取趋势图数据
      security:
        - BearerAuth: []
      parameters:
        - name: battery_id
          in: path
          required: true
          schema:
            type: integer
        - name: feature_name
          in: query
          required: true
          schema:
            type: string
            pattern: "^feature_[1-8]$"
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  cycles:
                    type: array
                    items:
                      type: integer
                  values:
                    type: array
                    items:
                      type: number

  /data/batteries/{battery_id}/scatter:
    get:
      tags: [Analysis]
      summary: 获取散点图数据 (RUL vs Feature)
      security:
        - BearerAuth: []
      parameters:
        - name: battery_id
          in: path
          required: true
          schema:
            type: integer
        - name: feature_name
          in: query
          schema:
            type: string
            default: "feature_1"
            pattern: "^feature_[1-8]$"
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  points:
                    type: array
                    items:
                      type: array
                      items:
                        type: number
                    description: "[[x, y], [x, y]]"

  /data/batteries/{battery_id}/pcl-distribution:
    get:
      tags: [Analysis]
      summary: 获取PCL分布数据
      security:
        - BearerAuth: []
      parameters:
        - name: battery_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  pcl_values:
                    type: array
                    items:
                      type: number

  /data/batteries/{battery_id}/correlation-matrix:
    get:
      tags: [Analysis]
      summary: 获取相关性矩阵 (热力图)
      security:
        - BearerAuth: []
      parameters:
        - name: battery_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  features:
                    type: array
                    items:
                      type: string
                  matrix:
                    type: array
                    items:
                      type: array
                      items:
                        type: number

  /data/batteries/{battery_id}/export-report:
    get:
      tags: [Analysis]
      summary: 导出分析报告 (Excel)
      security:
        - BearerAuth: []
      parameters:
        - name: battery_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary

  # ==========================================
  # Training
  # ==========================================
  /training/jobs:
    post:
      tags: [Training]
      summary: 创建训练任务
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [dataset_id, target, algorithms, batteries]
              properties:
                dataset_id:
                  type: integer
                target:
                  type: string
                  enum: [RUL, PCL, BOTH]
                algorithms:
                  type: array
                  items:
                    type: string
                batteries:
                  type: array
                  items:
                    type: object
                    properties:
                      battery_id:
                        type: integer
                      split_role:
                        type: string
                        enum: [train, val, test]
                # Hyperparameters
                seq_len:
                  type: integer
                  default: 1
                perc_val:
                  type: number
                  default: 0.2
                num_layers:
                  type: array
                  items:
                    type: integer
                  default: [2]
                num_neurons:
                  type: array
                  items:
                    type: integer
                  default: [128]
                num_epoch:
                  type: integer
                  default: 2000
                batch_size:
                  type: integer
                  default: 1024
                lr:
                  type: number
                  default: 0.001
                dropout_rate:
                  type: number
                  default: 0.2
                weight_decay:
                  type: number
                  default: 0.0
                step_size:
                  type: integer
                  default: 50000
                gamma:
                  type: number
                  default: 0.1
                lr_scheduler:
                  type: string
                  default: StepLR
                min_lr:
                  type: number
                  default: 1e-6
                grad_clip:
                  type: number
                  default: 0.0
                early_stopping_patience:
                  type: integer
                  default: 0
                monitor_metric:
                  type: string
                  default: val_loss
                num_rounds:
                  type: integer
                  default: 5
                random_seed:
                  type: integer
                  default: 1234
                inputs_dynamical:
                  type: string
                  default: "s_norm, t_norm"
                inputs_dim_dynamical:
                  type: string
                  default: "inputs_dim"
                loss_mode:
                  type: string
                  default: Sum
                loss_weights:
                  type: array
                  items:
                    type: number
                  default: [1.0, 1.0, 1.0]
      responses:
        "201":
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TrainingJobResponse"

    get:
      tags: [Training]
      summary: 列出训练任务
      security:
        - BearerAuth: []
      parameters:
        - name: status_filter
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TrainingJobResponse"

  /training/jobs/{job_id}:
    get:
      tags: [Training]
      summary: 获取训练任务详情
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  job:
                    $ref: "#/components/schemas/TrainingJobResponse"
                  runs:
                    type: array
                    items:
                      $ref: "#/components/schemas/TrainingRunResponse"
                  batteries:
                    type: array
                    items:
                      type: object
                      properties:
                        battery_id:
                          type: integer
                        battery_code:
                          type: string
                        split_role:
                          type: string
                        total_cycles:
                          type: integer

    delete:
      tags: [Training]
      summary: 删除训练任务 (软删除)
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: 删除成功

  /training/jobs/{job_id}/runs/{run_id}/metrics:
    get:
      tags: [Training]
      summary: 获取训练指标
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
        - name: run_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  run_id:
                    type: integer
                  algorithm:
                    type: string
                  metrics:
                    type: array
                    items:
                      type: object
                      properties:
                        epoch:
                          type: integer
                        train_loss:
                          type: number
                        val_loss:
                          type: number
                        metrics:
                          type: object

  /training/jobs/{job_id}/runs/{run_id}/logs:
    get:
      tags: [Training]
      summary: 获取训练日志 (从文件读取)
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
        - name: run_id
          in: path
          required: true
          schema:
            type: integer
        - name: level
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 1000
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  run_id:
                    type: integer
                  log_file_path:
                    type: string
                    nullable: true
                  total_lines:
                    type: integer
                  returned_lines:
                    type: integer
                  logs:
                    type: array
                    items:
                      type: object
                      properties:
                        timestamp:
                          type: string
                        level:
                          type: string
                        message:
                          type: string
                  message:
                    type: string

  /training/jobs/{job_id}/runs/{run_id}/logs/download:
    get:
      tags: [Training]
      summary: 下载训练日志文件
      description: 下载完整的训练日志文件供离线分析
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
        - name: run_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功返回日志文件
          content:
            text/plain:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
              description: 'attachment; filename="training_job_{job_id}_{algorithm}_{timestamp}.log"'
        "404":
          description: 训练任务、运行记录或日志文件不存在

  # ==========================================
  # Models
  # ==========================================
  /models/versions:
    get:
      tags: [Models]
      summary: 列出模型版本
      security:
        - BearerAuth: []
      parameters:
        - name: algorithm
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ModelVersionResponse"

  /models/versions/{version_id}:
    get:
      tags: [Models]
      summary: 获取模型详情
      security:
        - BearerAuth: []
      parameters:
        - name: version_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  model:
                    $ref: "#/components/schemas/ModelVersionResponse"
                  training_info:
                    type: object
                    nullable: true

    delete:
      tags: [Models]
      summary: 删除模型版本 (软删除)
      security:
        - BearerAuth: []
      parameters:
        - name: version_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: 删除成功

  /models/versions/{version_id}/download:
    get:
      tags: [Models]
      summary: 下载模型checkpoint
      security:
        - BearerAuth: []
      parameters:
        - name: version_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary

  /models/algorithms:
    get:
      tags: [Models]
      summary: 获取支持的算法列表
      security:
        - BearerAuth: []
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  algorithms:
                    type: array
                    items:
                      type: object
                      properties:
                        code:
                          type: string
                        name:
                          type: string
                        description:
                          type: string
                        supported:
                          type: boolean

  # ==========================================
  # Testing
  # ==========================================
  /testing/jobs:
    post:
      tags: [Testing]
      summary: 创建测试任务
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [model_version_id, dataset_id, target, battery_ids]
              properties:
                model_version_id:
                  type: integer
                dataset_id:
                  type: integer
                target:
                  type: string
                  enum: [RUL, PCL, BOTH]
                battery_ids:
                  type: array
                  items:
                    type: integer
                horizon:
                  type: integer
                  default: 1
      responses:
        "201":
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TestJobResponse"

    get:
      tags: [Testing]
      summary: 列出测试任务
      security:
        - BearerAuth: []
      parameters:
        - name: status_filter
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TestJobResponse"

  /testing/jobs/{job_id}:
    get:
      tags: [Testing]
      summary: 获取测试任务详情
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  job:
                    $ref: "#/components/schemas/TestJobResponse"
                  model_info:
                    type: object
                  batteries:
                    type: array
                    items:
                      type: object
                      properties:
                        battery_id:
                          type: integer
                        battery_code:
                          type: string
                        total_cycles:
                          type: integer

  /testing/jobs/{job_id}/metrics:
    get:
      tags: [Testing]
      summary: 获取测试指标
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: integer
                  overall_metrics:
                    type: array
                    items:
                      type: object
                      properties:
                        target:
                          type: string
                        metrics:
                          type: object
                  battery_metrics:
                    type: array
                    items:
                      type: object
                      properties:
                        battery_id:
                          type: integer
                        target:
                          type: string
                        metrics:
                          type: object

  /testing/jobs/{job_id}/predictions:
    get:
      tags: [Testing]
      summary: 获取预测结果
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
        - name: battery_id
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: integer
                  predictions:
                    type: array
                    items:
                      type: object
                      properties:
                        battery_id:
                          type: integer
                        cycle_num:
                          type: integer
                        target:
                          type: string
                        y_true:
                          type: number
                        y_pred:
                          type: number

  /testing/jobs/{job_id}/logs:
    get:
      tags: [Testing]
      summary: 获取测试日志 (从文件读取)
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
        - name: level
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 1000
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: integer
                  log_file_path:
                    type: string
                    nullable: true
                  total_lines:
                    type: integer
                  returned_lines:
                    type: integer
                  logs:
                    type: array
                    items:
                      type: object
                      properties:
                        timestamp:
                          type: string
                        level:
                          type: string
                        message:
                          type: string
                  message:
                    type: string

  /testing/jobs/{job_id}/export:
    post:
      tags: [Testing]
      summary: 导出测试结果
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
        - name: format
          in: query
          schema:
            type: string
            enum: [CSV, XLSX]
            default: CSV
      responses:
        "200":
          description: 导出任务已创建
          content:
            application/json:
              schema:
                type: object
                properties:
                  export_id:
                    type: integer
                  status:
                    type: string
                  message:
                    type: string

  # ==========================================
  # WebSocket
  # ==========================================
  /training/ws/jobs/{job_id}:
    get:
      tags: [WebSocket]
      summary: 训练任务WebSocket
      description: |
        实时接收训练进度

        消息类型:
        - log: 日志消息
        - epoch_progress: Epoch进度
        - run_status_change: 状态变化
        - job_progress: 任务进度

        连接: ws://localhost:8000/api/v1/training/ws/jobs/{job_id}
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "101":
          description: 切换到WebSocket

  /testing/ws/jobs/{job_id}:
    get:
      tags: [WebSocket]
      summary: 测试任务WebSocket
      description: |
        实时接收测试进度

        消息类型:
        - log: 日志消息
        - progress: 阶段进度
        - status_change: 状态变化

        连接: ws://localhost:8000/api/v1/testing/ws/jobs/{job_id}
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "101":
          description: 切换到WebSocket

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    TrainingJobResponse:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        dataset_id:
          type: integer
        target:
          type: string
        hyperparams:
          type: object
        status:
          type: string
        progress:
          type: number
        created_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
          nullable: true
        finished_at:
          type: string
          format: date-time
          nullable: true

    TrainingRunResponse:
      type: object
      properties:
        id:
          type: integer
        job_id:
          type: integer
        algorithm:
          type: string
        status:
          type: string
        current_epoch:
          type: integer
        total_epochs:
          type: integer
        started_at:
          type: string
          format: date-time
          nullable: true
        finished_at:
          type: string
          format: date-time
          nullable: true

    ModelVersionResponse:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        run_id:
          type: integer
        algorithm:
          type: string
          enum: [BASELINE, BILSTM, DEEPHPM]
        target:
          type: string
          enum: [RUL, PCL]
          description: 训练目标（从训练任务继承）
        name:
          type: string
        version:
          type: string
        config:
          type: object
        metrics:
          type: object
        checkpoint_path:
          type: string
        created_at:
          type: string
          format: date-time

    TestJobResponse:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        model_version_id:
          type: integer
        dataset_id:
          type: integer
        target:
          type: string
        horizon:
          type: integer
        status:
          type: string
        created_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
          nullable: true
        finished_at:
          type: string
          format: date-time
          nullable: true
