openapi: 3.0.0
info:
  title: Battery Analysis Platform API
  description: |
    储能电池寿命分析及算法测试平台 API 规范

    核心功能:
    - 用户认证与授权 (JWT)
    - 数据管理与可视化分析
    - 训练平台 (Baseline/BiLSTM/DeepHPM)
    - 测试平台 (模型推理评估)
    - 模型版本管理
    - WebSocket实时进度推送
  version: 1.0.0

servers:
  - url: http://localhost:8000/api/v1
    description: 本地开发服务器

tags:
  - name: Authentication
    description: 用户认证与授权
  - name: Data Management
    description: 数据集和电池数据管理
  - name: Analysis
    description: 数据可视化分析
  - name: Training
    description: 训练平台
  - name: Models
    description: 模型版本管理
  - name: Testing
    description: 测试平台
  - name: WebSocket
    description: WebSocket实时推送

paths:
  # ==========================================
  # Authentication
  # ==========================================
  /v1/auth/register:
    post:
      tags: [Authentication]
      summary: 用户注册
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_name, email, password]
              properties:
                user_name:
                  type: string
                email:
                  type: string
                password:
                  type: string
      responses:
        "201":
          description: 注册成功

  /v1/auth/login:
    post:
      tags: [Authentication]
      summary: 用户登录
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                username:
                  type: string
                password:
                  type: string
      responses:
        "200":
          description: 登录成功

  /v1/auth/me:
    get:
      tags: [Authentication]
      summary: 获取当前用户信息
      security:
        - BearerAuth: []
      responses:
        "200":
          description: 成功

  /v1/auth/logout:
    post:
      tags: [Authentication]
      summary: 用户登出
      security:
        - BearerAuth: []
      responses:
        "200":
          description: 登出成功

  # ==========================================
  # Data Management
  # ==========================================
  /v1/data/datasets:
    get:
      tags: [Data Management]
      summary: 获取数据集列表
      security:
        - BearerAuth: []
      responses:
        "200":
          description: 成功

  /v1/data/datasets/{dataset_id}/batteries:
    get:
      tags: [Data Management]
      summary: 获取电池列表
      security:
        - BearerAuth: []
      parameters:
        - name: dataset_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功

  /v1/data/batteries/{battery_id}/cycles:
    get:
      tags: [Data Management]
      summary: 获取循环数据
      security:
        - BearerAuth: []
      parameters:
        - name: battery_id
          in: path
          required: true
          schema:
            type: integer
        - name: skip
          in: query
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: 成功

  # ==========================================
  # Analysis
  # ==========================================
  /v1/data/batteries/{battery_id}/stats:
    get:
      tags: [Analysis]
      summary: 获取特征统计
      security:
        - BearerAuth: []
      parameters:
        - name: battery_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功

  /v1/data/batteries/{battery_id}/trend:
    get:
      tags: [Analysis]
      summary: 获取趋势数据
      security:
        - BearerAuth: []
      parameters:
        - name: battery_id
          in: path
          required: true
          schema:
            type: integer
        - name: feature_name
          in: query
          required: true
          schema:
            type: string
      responses:
        "200":
          description: 成功

  /v1/data/batteries/{battery_id}/scatter:
    get:
      tags: [Analysis]
      summary: 获取散点图数据
      security:
        - BearerAuth: []
      parameters:
        - name: battery_id
          in: path
          required: true
          schema:
            type: integer
        - name: feature_name
          in: query
          schema:
            type: string
      responses:
        "200":
          description: 成功

  /v1/data/batteries/{battery_id}/pcl-distribution:
    get:
      tags: [Analysis]
      summary: 获取PCL分布
      security:
        - BearerAuth: []
      parameters:
        - name: battery_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功

  /v1/data/batteries/{battery_id}/correlation-matrix:
    get:
      tags: [Analysis]
      summary: 获取相关性矩阵
      security:
        - BearerAuth: []
      parameters:
        - name: battery_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功

  # ==========================================
  # Training
  # ==========================================
  /v1/training/jobs:
    post:
      tags: [Training]
      summary: 创建训练任务
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                dataset_id:
                  type: integer
                target:
                  type: string
                algorithms:
                  type: array
                  items:
                    type: string
                batteries:
                  type: array
                  items:
                    type: object
      responses:
        "201":
          description: 创建成功

    get:
      tags: [Training]
      summary: 列出训练任务
      security:
        - BearerAuth: []
      parameters:
        - name: status_filter
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
        - name: offset
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: 成功

  /v1/training/jobs/{job_id}:
    get:
      tags: [Training]
      summary: 获取训练任务详情
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功

    delete:
      tags: [Training]
      summary: 删除训练任务
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: 删除成功

  /v1/training/jobs/{job_id}/runs/{run_id}/metrics:
    get:
      tags: [Training]
      summary: 获取训练指标
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
        - name: run_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功

  /v1/training/jobs/{job_id}/runs/{run_id}/logs:
    get:
      tags: [Training]
      summary: 获取训练日志（从文件读取）
      description: |
        从日志文件读取训练日志

        返回格式:
        - run_id: 运行ID
        - log_file_path: 日志文件路径
        - total_lines: 文件总行数
        - returned_lines: 返回的日志行数
        - logs: 日志数组，每条包含 timestamp, level, message

        注意: 日志现在存储在文件中，不再存储在数据库
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
        - name: run_id
          in: path
          required: true
          schema:
            type: integer
        - name: level
          in: query
          description: 按日志级别过滤 (DEBUG/INFO/WARNING/ERROR)
          schema:
            type: string
        - name: limit
          in: query
          description: 返回最新的N条日志，默认1000
          schema:
            type: integer
            default: 1000
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  run_id:
                    type: integer
                  log_file_path:
                    type: string
                    description: 日志文件相对路径
                  total_lines:
                    type: integer
                    description: 文件总行数
                  returned_lines:
                    type: integer
                    description: 返回的日志行数
                  logs:
                    type: array
                    items:
                      type: object
                      properties:
                        timestamp:
                          type: string
                        level:
                          type: string
                        message:
                          type: string
                  message:
                    type: string
                    description: 当日志文件不存在时的提示信息

  # ==========================================
  # Models
  # ==========================================
  /v1/models/versions:
    get:
      tags: [Models]
      summary: 列出模型版本
      security:
        - BearerAuth: []
      parameters:
        - name: algorithm
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
        - name: offset
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: 成功

  /v1/models/versions/{version_id}:
    get:
      tags: [Models]
      summary: 获取模型详情
      security:
        - BearerAuth: []
      parameters:
        - name: version_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功

    delete:
      tags: [Models]
      summary: 删除模型版本
      security:
        - BearerAuth: []
      parameters:
        - name: version_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: 删除成功

  /v1/models/versions/{version_id}/download:
    get:
      tags: [Models]
      summary: 下载模型checkpoint
      security:
        - BearerAuth: []
      parameters:
        - name: version_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功

  /v1/models/algorithms:
    get:
      tags: [Models]
      summary: 获取支持的算法列表
      security:
        - BearerAuth: []
      responses:
        "200":
          description: 成功

  # ==========================================
  # Testing
  # ==========================================
  /v1/testing/jobs:
    post:
      tags: [Testing]
      summary: 创建测试任务
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                model_version_id:
                  type: integer
                dataset_id:
                  type: integer
                target:
                  type: string
                battery_ids:
                  type: array
                  items:
                    type: integer
                horizon:
                  type: integer
      responses:
        "201":
          description: 创建成功

    get:
      tags: [Testing]
      summary: 列出测试任务
      security:
        - BearerAuth: []
      parameters:
        - name: status_filter
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
        - name: offset
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: 成功

  /v1/testing/jobs/{job_id}:
    get:
      tags: [Testing]
      summary: 获取测试任务详情
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功

  /v1/testing/jobs/{job_id}/metrics:
    get:
      tags: [Testing]
      summary: 获取测试指标
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: 成功

  /v1/testing/jobs/{job_id}/predictions:
    get:
      tags: [Testing]
      summary: 获取预测结果
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
        - name: battery_id
          in: query
          schema:
            type: integer
      responses:
        "200":
          description: 成功

  /v1/testing/jobs/{job_id}/logs:
    get:
      tags: [Testing]
      summary: 获取测试日志（从文件读取）
      description: |
        从日志文件读取测试日志

        返回格式:
        - job_id: 测试任务ID
        - log_file_path: 日志文件路径
        - total_lines: 文件总行数
        - returned_lines: 返回的日志行数
        - logs: 日志数组，每条包含 timestamp, level, message

        注意: 日志现在存储在文件中，不再存储在数据库
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
        - name: level
          in: query
          description: 按日志级别过滤 (DEBUG/INFO/WARNING/ERROR)
          schema:
            type: string
        - name: limit
          in: query
          description: 返回最新的N条日志，默认1000
          schema:
            type: integer
            default: 1000
      responses:
        "200":
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: integer
                  log_file_path:
                    type: string
                    description: 日志文件相对路径
                  total_lines:
                    type: integer
                    description: 文件总行数
                  returned_lines:
                    type: integer
                    description: 返回的日志行数
                  logs:
                    type: array
                    items:
                      type: object
                      properties:
                        timestamp:
                          type: string
                        level:
                          type: string
                        message:
                          type: string
                  message:
                    type: string
                    description: 当日志文件不存在时的提示信息

  /v1/testing/jobs/{job_id}/export:
    post:
      tags: [Testing]
      summary: 导出测试结果
      security:
        - BearerAuth: []
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
        - name: format
          in: query
          schema:
            type: string
            enum: [CSV, XLSX]
      responses:
        "200":
          description: 导出任务已创建

  # ==========================================
  # WebSocket
  # ==========================================
  /v1/training/ws/jobs/{job_id}:
    get:
      tags: [WebSocket]
      summary: 训练任务WebSocket
      description: |
        实时接收训练进度

        消息类型:
        - log: 日志消息（仅推送 WARNING 和 ERROR 级别）
        - training_detail: Period级详情
        - epoch_progress: Epoch进度
        - run_status_change: 状态变化
        - job_progress: 任务进度

        注意:
        - 完整日志存储在文件中，可通过日志API查询
        - WebSocket仅推送关键日志（WARNING/ERROR）以减少网络流量

        连接: ws://localhost:8000/api/v1/training/ws/jobs/{job_id}
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "101":
          description: 切换到WebSocket

  /v1/testing/ws/jobs/{job_id}:
    get:
      tags: [WebSocket]
      summary: 测试任务WebSocket
      description: |
        实时接收测试进度

        消息类型:
        - log: 日志消息（仅推送 WARNING 和 ERROR 级别）
        - progress: 阶段进度
        - status_change: 状态变化

        注意:
        - 完整日志存储在文件中，可通过日志API查询
        - WebSocket仅推送关键日志（WARNING/ERROR）以减少网络流量

        连接: ws://localhost:8000/api/v1/testing/ws/jobs/{job_id}
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "101":
          description: 切换到WebSocket

  # ==========================================
  # Health Check
  # ==========================================
  /health:
    get:
      tags: [System]
      summary: 健康检查
      responses:
        "200":
          description: 服务正常

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Error:
      type: object
      properties:
        detail:
          type: string
